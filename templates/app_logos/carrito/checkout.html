{% extends 'base.html' %}

{% block title %}Checkout - Logo's Bookstore{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       CHECKOUT SIMPLIFICADO - SIN PROBLEMAS DE OVERLAY
    ============================================ */
    
    /* Añadir clase checkout-page al body via JavaScript para activar fixes */
    body.checkout-page {
        background: #ffffff !important;
        overflow: auto !important;
    }
    
    .checkout-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 140px 2rem 4rem;
    }
    
    /* Header */
    .checkout-header {
        margin-bottom: 3rem;
        text-align: center;
    }
    
    .checkout-title {
        font-size: 2.5rem;
        font-weight: 300;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .checkout-subtitle {
        font-family: 'Cormorant Garamond', serif;
        font-size: 1.2rem;
        color: #7f8c8d;
        font-style: italic;
    }
    
    /* Progreso */
    .checkout-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .progress-step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }
    
    .step-number {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: white;
        border: 2px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .progress-step.active .step-number {
        background: #d4af37;
        border-color: #d4af37;
        color: white;
    }
    
    .step-title {
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.9rem;
    }
    
    /* Grid principal */
    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 2rem;
        margin-bottom: 3rem;
    }
    
    /* Formulario principal - SIMPLE Y FUNCIONAL */
    .checkout-form {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    /* Panel de resumen */
    .order-summary {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        position: sticky;
        top: 100px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    /* Secciones */
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .section-icon {
        width: 40px;
        height: 40px;
        background: #d4af37;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 400;
        color: #2c3e50;
        margin: 0;
    }
    
    /* CAMPOS DEL FORMULARIO - SIMPLES Y EDITABLES */
    .form-group-checkout {
        margin-bottom: 1rem;
    }
    
    .form-label-checkout {
        display: block;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .form-control-checkout {
        width: 100%;
        padding: 0.875rem 1rem;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 1rem;
        color: #212529;
        box-sizing: border-box;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control-checkout:focus {
        border-color: #d4af37;
        box-shadow: 0 0 0 0.2rem rgba(212, 175, 55, 0.25);
        outline: 0;
    }
    
    /* Grid de campos */
    .field-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    /* Métodos de envío */
    .shipping-methods {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .shipping-method {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .shipping-method:hover {
        background: #e9ecef;
    }
    
    .shipping-method.selected {
        background: rgba(212, 175, 55, 0.1);
        border-color: #d4af37;
    }
    
    .shipping-icon {
        width: 40px;
        height: 40px;
        background: #4682b4;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .shipping-details {
        flex: 1;
    }
    
    .shipping-title {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    .shipping-description {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .shipping-price {
        font-weight: 600;
        color: #2c3e50;
    }
    
    /* Métodos de pago */
    .payment-methods {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .payment-method {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .payment-method:hover {
        background: #e9ecef;
    }
    
    .payment-method.selected {
        background: rgba(212, 175, 55, 0.1);
        border-color: #d4af37;
    }
    
    .payment-icon {
        width: 40px;
        height: 40px;
        background: #4682b4;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .payment-details {
        flex: 1;
    }
    
    .payment-title {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    /* Formulario de tarjeta */
    .card-form {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }
    
    /* Botón de confirmación */
    .confirm-button {
        width: 100%;
        padding: 1rem;
        background: #d4af37;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1.1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }
    
    .confirm-button:hover {
        background: #c19b2e;
    }
    
    .confirm-button:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
    
    /* Lista de productos */
    .product-list {
        margin-bottom: 1.5rem;
    }
    
    .product-item {
        display: flex;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid #eee;
    }
    
    .product-item:last-child {
        border-bottom: none;
    }
    
    .product-image {
        width: 60px;
        height: 80px;
        border-radius: 4px;
        overflow: hidden;
        flex-shrink: 0;
    }
    
    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .product-details {
        flex: 1;
    }
    
    .product-title {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .product-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .product-price {
        font-weight: 600;
        color: #2c3e50;
    }
    
    /* Totales */
    .totals {
        margin: 1.5rem 0;
        padding: 1.5rem 0;
        border-top: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        color: #6c757d;
    }
    
    .total-row:last-child {
        margin-bottom: 0;
    }
    
    .total-row.grand-total {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    
    /* Seguridad */
    .security-info {
        padding: 1rem;
        background: #e3f2fd;
        border-radius: 6px;
        border: 1px solid #bbdefb;
        margin-top: 1.5rem;
    }
    
    .security-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .security-icon {
        color: #1976d2;
        font-size: 1.25rem;
    }
    
    .security-text {
        font-size: 0.85rem;
        color: #1976d2;
        line-height: 1.4;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
        .checkout-grid {
            grid-template-columns: 1fr;
        }
        
        .order-summary {
            position: static;
            max-height: none;
        }
        
        .field-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .checkout-container {
            padding: 120px 1rem 2rem;
        }
        
        .checkout-progress {
            flex-direction: column;
            gap: 1rem;
        }
        
        .checkout-form,
        .order-summary {
            padding: 1.5rem;
        }
        
        .checkout-title {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
    <!-- Header -->
    <div class="checkout-header">
        <h1 class="checkout-title">Finalizar Compra</h1>
        <p class="checkout-subtitle">Completa tu pedido de manera segura</p>
    </div>
    
    <!-- Progreso -->
    <div class="checkout-progress">
        <div class="progress-step active">
            <div class="step-number">1</div>
            <div class="step-title">Información de Envío</div>
        </div>
        <div class="progress-step">
            <div class="step-number">2</div>
            <div class="step-title">Método de Pago</div>
        </div>
        <div class="progress-step">
            <div class="step-number">3</div>
            <div class="step-title">Confirmación</div>
        </div>
    </div>
    
    <!-- Grid principal -->
    <div class="checkout-grid">
        <!-- Formulario principal -->
        <div class="checkout-form">
            <form id="checkoutForm" method="POST" action="{% url 'procesar_pago' %}">
                {% csrf_token %}
                
                <!-- Información de envío -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <h2 class="section-title">Información de Envío</h2>
                    </div>
                    
                    <div class="field-grid">
                        <div class="form-group-checkout">
                            <label class="form-label-checkout">Nombre Completo *</label>
                            <input type="text" 
                                   class="form-control-checkout" 
                                   name="full_name" 
                                   required
                                   placeholder="Juan Pérez"
                                   value="{% if user.is_authenticated %}{{ user.get_full_name }}{% endif %}">
                        </div>
                        
                        <div class="form-group-checkout">
                            <label class="form-label-checkout">Correo Electrónico *</label>
                            <input type="email" 
                                   class="form-control-checkout" 
                                   name="email" 
                                   required
                                   placeholder="juan@ejemplo.com"
                                   value="{% if user.is_authenticated %}{{ user.email }}{% endif %}">
                        </div>
                        
                        <div class="form-group-checkout">
                            <label class="form-label-checkout">Teléfono *</label>
                            <input type="tel" 
                                   class="form-control-checkout" 
                                   name="phone" 
                                   required
                                   placeholder="+52 123 456 7890">
                        </div>
                        
                        <div class="form-group-checkout">
                            <label class="form-label-checkout">Dirección *</label>
                            <input type="text" 
                                   class="form-control-checkout" 
                                   name="address" 
                                   required
                                   placeholder="Calle, número, colonia">
                        </div>
                        
                        <div class="form-group-checkout">
                            <label class="form-label-checkout">Ciudad *</label>
                            <input type="text" 
                                   class="form-control-checkout" 
                                   name="city" 
                                   required
                                   placeholder="Ciudad">
                        </div>
                        
                        <div class="form-group-checkout">
                            <label class="form-label-checkout">Código Postal *</label>
                            <input type="text" 
                                   class="form-control-checkout" 
                                   name="zip_code" 
                                   required
                                   placeholder="12345">
                        </div>
                    </div>
                </div>
                
                <!-- Método de envío -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="bi bi-truck"></i>
                        </div>
                        <h2 class="section-title">Método de Envío</h2>
                    </div>
                    
                    <div class="shipping-methods">
                        <div class="shipping-method selected" data-shipping="standard">
                            <div class="shipping-icon">
                                <i class="bi bi-truck"></i>
                            </div>
                            <div class="shipping-details">
                                <div class="shipping-title">Envío Estándar</div>
                                <div class="shipping-description">3-5 días hábiles</div>
                            </div>
                            <div class="shipping-price">$49.00</div>
                        </div>
                        
                        <div class="shipping-method" data-shipping="express">
                            <div class="shipping-icon" style="background: #d4af37;">
                                <i class="bi bi-lightning"></i>
                            </div>
                            <div class="shipping-details">
                                <div class="shipping-title">Envío Express</div>
                                <div class="shipping-description">1-2 días hábiles</div>
                            </div>
                            <div class="shipping-price">$99.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Método de pago -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="bi bi-credit-card"></i>
                        </div>
                        <h2 class="section-title">Método de Pago</h2>
                    </div>
                    
                    <div class="payment-methods">
                        <div class="payment-method selected" data-payment="card">
                            <div class="payment-icon">
                                <i class="bi bi-credit-card"></i>
                            </div>
                            <div class="payment-details">
                                <div class="payment-title">Tarjeta de Crédito/Débito</div>
                            </div>
                        </div>
                        
                        <div class="payment-method" data-payment="paypal">
                            <div class="payment-icon" style="background: #003087;">
                                <i class="bi bi-paypal"></i>
                            </div>
                            <div class="payment-details">
                                <div class="payment-title">PayPal</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulario de tarjeta -->
                    <div class="card-form" id="cardForm">
                        <div class="field-grid">
                            <div class="form-group-checkout">
                                <label class="form-label-checkout">Número de Tarjeta *</label>
                                <input type="text" 
                                       class="form-control-checkout" 
                                       name="card_number" 
                                       placeholder="1234 5678 9012 3456"
                                       id="cardNumber">
                            </div>
                            
                            <div class="form-group-checkout">
                                <label class="form-label-checkout">Nombre del Titular *</label>
                                <input type="text" 
                                       class="form-control-checkout" 
                                       name="card_holder" 
                                       placeholder="JUAN PEREZ"
                                       id="cardHolder">
                            </div>
                            
                            <div class="form-group-checkout">
                                <label class="form-label-checkout">Fecha de Expiración *</label>
                                <input type="text" 
                                       class="form-control-checkout" 
                                       name="card_expiry" 
                                       placeholder="MM/AA"
                                       id="cardExpiry">
                            </div>
                            
                            <div class="form-group-checkout">
                                <label class="form-label-checkout">CVV *</label>
                                <input type="text" 
                                       class="form-control-checkout" 
                                       name="card_cvv" 
                                       placeholder="123">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Campos ocultos -->
                <input type="hidden" name="shipping_method" id="shippingMethod" value="standard">
                <input type="hidden" name="payment_method" id="paymentMethod" value="card">
                
                <button type="submit" class="confirm-button" id="confirmOrder">
                    <i class="bi bi-lock"></i>
                    Confirmar y Pagar
                </button>
            </form>
        </div>
        
        <!-- Resumen del pedido -->
        <div class="order-summary">
            <h2 class="section-title">Resumen del Pedido</h2>
            
            <!-- Lista de productos -->
            <div class="product-list">
                {% if carrito_items %}
                    {% for item in carrito_items %}
                    <div class="product-item">
                        <div class="product-image">
                            {% if item.libro.imagen %}
                                <img src="{{ item.libro.imagen.url }}" alt="{{ item.libro.titulo }}">
                            {% else %}
                                <div style="width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                                    <i class="bi bi-book" style="color: #999;"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="product-details">
                            <div class="product-title">{{ item.libro.titulo|truncatechars:40 }}</div>
                            <div class="product-meta">
                                <span>Cantidad: {{ item.cantidad }}</span>
                                <span>{{ item.libro.autor.nombre|truncatechars:15 }}</span>
                            </div>
                            <div class="product-price">${{ item.get_total|floatformat:2 }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-cart-x" style="font-size: 2rem; color: #dee2e6; margin-bottom: 1rem;"></i>
                        <p style="color: #6c757d;">No hay productos en el carrito</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Totales -->
            <div class="totals">
                <div class="total-row">
                    <span>Subtotal</span>
                    <span>${{ subtotal|floatformat:2 }}</span>
                </div>
                <div class="total-row">
                    <span>Envío</span>
                    <span id="shippingCost">$49.00</span>
                </div>
                <div class="total-row">
                    <span>Impuestos (16%)</span>
                    <span id="taxes">${{ impuestos|floatformat:2 }}</span>
                </div>
                <div class="total-row grand-total">
                    <span>Total</span>
                    <span id="grandTotal">${{ total|floatformat:2 }}</span>
                </div>
            </div>
            
            <!-- Seguridad -->
            <div class="security-info">
                <div class="security-content">
                    <i class="bi bi-shield-check security-icon"></i>
                    <p class="security-text">
                        Tu información está protegida con encriptación SSL de 256-bit. 
                        Nunca almacenamos los datos de tu tarjeta de crédito.
                    </p>
                </div>
            </div>
            
            <!-- Términos -->
            <div class="text-center mt-3">
                <small style="color: #6c757d;">
                    Al hacer clic, aceptas nuestros 
                    <a href="#" style="color: #d4af37; text-decoration: none;">Términos y Condiciones</a>
                </small>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== CHECKOUT PAGE - INICIALIZACIÓN ===');
        
        // 1. AGREGAR CLASE checkout-page AL BODY PARA ACTIVAR FIXES
        document.body.classList.add('checkout-page');
        
        // 2. DESACTIVAR TEMPORALMENTE LA FUNCIÓN DE PARTÍCULAS
        if (typeof window.createParticles === 'function') {
            const originalCreateParticles = window.createParticles;
            window.createParticles = function() {
                console.log('Partículas deshabilitadas para checkout');
            };
        }
        
        // 3. VARIABLES DE CÁLCULO
        const subtotal = parseFloat("{{ subtotal|default:0 }}");
        let shippingCost = 49.00;
        let shippingMethod = 'standard';
        let paymentMethod = 'card';
        
        // 4. SELECCIÓN DE MÉTODOS DE ENVÍO
        const shippingMethods = document.querySelectorAll('.shipping-method');
        const shippingMethodInput = document.getElementById('shippingMethod');
        
        shippingMethods.forEach(method => {
            method.addEventListener('click', function() {
                // Remover selección anterior
                shippingMethods.forEach(m => m.classList.remove('selected'));
                
                // Seleccionar nuevo método
                this.classList.add('selected');
                
                // Actualizar costo de envío
                shippingMethod = this.dataset.shipping;
                shippingCost = shippingMethod === 'express' ? 99.00 : 49.00;
                shippingMethodInput.value = shippingMethod;
                
                // Actualizar UI
                document.getElementById('shippingCost').textContent = `$${shippingCost.toFixed(2)}`;
                
                // Recalcular total
                updateTotal();
            });
        });
        
        // 5. SELECCIÓN DE MÉTODOS DE PAGO
        const paymentMethods = document.querySelectorAll('.payment-method');
        const cardForm = document.getElementById('cardForm');
        const paymentMethodInput = document.getElementById('paymentMethod');
        
        paymentMethods.forEach(method => {
            method.addEventListener('click', function() {
                // Remover selección anterior
                paymentMethods.forEach(m => m.classList.remove('selected'));
                
                // Seleccionar nuevo método
                this.classList.add('selected');
                paymentMethod = this.dataset.payment;
                paymentMethodInput.value = paymentMethod;
                
                // Mostrar/ocultar formulario de tarjeta
                if (paymentMethod === 'card') {
                    cardForm.style.display = 'block';
                } else {
                    cardForm.style.display = 'none';
                }
            });
        });
        
        // 6. FUNCIÓN PARA ACTUALIZAR TOTAL
        function updateTotal() {
            const tax = subtotal * 0.16;
            const grandTotal = subtotal + shippingCost + tax;
            
            document.getElementById('taxes').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
            
            console.log('Total actualizado:', {
                subtotal: subtotal,
                shipping: shippingCost,
                tax: tax,
                total: grandTotal
            });
        }
        
        // 7. FORMATEAR NÚMERO DE TARJETA
        const cardNumberInput = document.getElementById('cardNumber');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                value = value.replace(/(\d{4})/g, '$1 ').trim();
                if (value.length > 19) value = value.substring(0, 19);
                this.value = value;
            });
        }
        
        // 8. FORMATEAR FECHA DE EXPIRACIÓN
        const cardExpiryInput = document.getElementById('cardExpiry');
        if (cardExpiryInput) {
            cardExpiryInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                if (value.length > 5) value = value.substring(0, 5);
                this.value = value;
            });
        }
        
        // 9. VALIDACIÓN DEL FORMULARIO
        const checkoutForm = document.getElementById('checkoutForm');
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', function(e) {
                console.log('Validando formulario...');
                
                let isValid = true;
                const requiredFields = this.querySelectorAll('[required]');
                
                // Validar campos requeridos generales
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.style.borderColor = '#e74c3c';
                        isValid = false;
                    } else {
                        field.style.borderColor = '';
                    }
                });
                
                // Validar campos de tarjeta si se seleccionó ese método
                if (paymentMethod === 'card') {
                    const cardFields = ['cardNumber', 'cardHolder', 'cardExpiry', 'cardCvv'];
                    cardFields.forEach(fieldName => {
                        const field = document.getElementById(fieldName) || 
                                     document.querySelector(`[name="${fieldName}"]`);
                        if (field && !field.value.trim()) {
                            field.style.borderColor = '#e74c3c';
                            isValid = false;
                        }
                    });
                    
                    // Validar formato de tarjeta
                    if (cardNumberInput && cardNumberInput.value.replace(/\D/g, '').length < 16) {
                        cardNumberInput.style.borderColor = '#e74c3c';
                        isValid = false;
                    }
                    
                    // Validar formato de fecha
                    if (cardExpiryInput && !/^\d{2}\/\d{2}$/.test(cardExpiryInput.value)) {
                        cardExpiryInput.style.borderColor = '#e74c3c';
                        isValid = false;
                    }
                }
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Por favor, corrige los errores en el formulario.');
                    return false;
                }
                
                // Mostrar loading
                const confirmButton = document.getElementById('confirmOrder');
                if (confirmButton) {
                    confirmButton.disabled = true;
                    confirmButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Procesando...';
                }
                
                console.log('Formulario válido, enviando...');
                return true;
            });
        }
        
        // 10. INICIALIZAR TOTAL
        updateTotal();
        
        // 11. ASEGURAR QUE LOS INPUTS SEAN EDITABLES
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            // Forzar que sean editables
            input.removeAttribute('readonly');
            input.removeAttribute('disabled');
            input.style.pointerEvents = 'auto';
            input.style.opacity = '1';
            input.style.cursor = 'text';
            
            // Añadir estilos de focus
            input.addEventListener('focus', function() {
                this.style.borderColor = '#d4af37';
                this.style.boxShadow = '0 0 0 0.2rem rgba(212, 175, 55, 0.25)';
            });
            
            input.addEventListener('blur', function() {
                this.style.borderColor = '';
                this.style.boxShadow = '';
            });
        });
        
        console.log('=== CHECKOUT PAGE - INICIALIZACIÓN COMPLETA ===');
    });
</script>
{% endblock %}